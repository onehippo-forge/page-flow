<!DOCTYPE html>
    <!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 6 Apr 2018 
 | Rendered using Hippo Forge Maven Skin 2.0.1 based on Apache Maven Fluido Skin
-->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                  <meta name="Date-Revision-yyyymmdd" content="20180406" />
              <meta http-equiv="Content-Language" content="en" />
      <title>Hippo Forge Page Flow &#x2013; </title>
  <link rel="stylesheet" href="./css/forge-maven-skin-syntaxhighlighter-2.0.1.min.css"/>
  <link rel="stylesheet" href="./css/forge-maven-skin-2.0.1.min.css"/>
  <link rel="stylesheet" href="./css/site.css" />
  <link rel="stylesheet" href="./css/print.css" media="print" />
  
  <script type="text/javascript" src="./js/forge-maven-skin-syntaxhighlighter-2.0.1.min.js"></script>
  <script type="text/javascript" src="./js/forge-maven-skin-2.0.1.min.js"></script>

    </head>
<body class="topBarDisabled">
                        <a href="https://github.com/onehippo-forge/page-flow">
    <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
         src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
         alt="Fork me on GitHub">
  </a>
          <div class="container-fluid">
  <div id="banner">
    <div id="logo">
      <a href="http://www.github.com/onehippo-forge">
        <img src="./images/hipposkin/hippo-forge-logo.png" alt="Hippo Forge Logo" />
      </a>
    </div>
    <div class="pull-left">              <div id="bannerLeft">    <h1>Page Flow</h1>
    </div>
              </div>
    <div class="pull-right"></div>
    <div class="clear"><hr/></div>
  </div>

  <div id="breadcrumbs">
    <div class="links">
      <a href="https://www.bloomreach.com">bloomreach.com</a>
      <a href="https://www.onehippo.org">onehippo.org</a>
    </div>
    <ul class="breadcrumb">
    
  <li id="publishDate">published: 6 Apr 2018  
  </li>
  
        
            </ul>
    <div class="clear"><hr/></div>
  </div>
<div class="row-fluid">
  <div id="leftColumn" class="span2">
    <div class="well sidebar-nav">
    
    <ul class="nav nav-list">
            <li>  <a href="index.html" title="Home">  <span class="none"></span>  Home</a>  </li>
        <li>  <a href="demoproject.html" title="Demo Project">  <span class="none"></span>  Demo Project</a>  </li>
        <li>  <a href="install.html" title="Installation">  <span class="none"></span>  Installation</a>  </li>
        <li>  <a href="configure.html" title="Configuration">  <span class="none"></span>  Configuration</a>  </li>
        <li class="active">  <a href="#"><span class="none"></span>Developer's How-to</a>
  </li>
        <li>  <a href="apidocs/index.html" title="JavaDocs">  <span class="none"></span>  JavaDocs</a>  </li>
        <li>  <a href="release-notes.html" title="Release Notes">  <span class="none"></span>  Release Notes</a>  </li>
        </ul>
    
          <hr />
      <div id="poweredBy">
                <div class="clear"></div>
                <div class="clear"></div>
                <div class="clear"></div>
                <div class="clear"></div>
              <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">  <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />  </a>
          </div>
    </div>
  </div>
  <div id="bodyColumn"  class="span10" >
    <div class="section">
<h2><a name="Developers_How-to"></a>Developer&#x2019;s How-to</h2>
<div class="section">
<h3><a name="Introduction"></a>Introduction</h3>
<p><b>Page Flow Module</b> simplifies Page State definitions, Page State Transitions based on Events, Error Handling per Page State and metadata handlings in web applications.</p>
<p>Normally, each Page State is mapped to an HST Page with an unique URI path info. You may have multiple, different <tt>HstComponent</tt>s in each HST Page like you do in normal HST-2 web application development.</p>
<p>As <b>Page Flow Module</b> aims to cover visitors&#x2019; interactions across (multi-step) HST Pages, it is not interested in providing too tightly coupled framework with MVC form/action handling, unlike Spring Web Flow for example.</p>
<p>In that sense, it is the <tt>HstComponent</tt>s responsibility to send an event to trigger Page State Transitions. <b>Page Flow Module</b> would not send events or trigger transitions on a Page Flow instance automatically based on <tt>HstComponent</tt>&#x2019;s status changes.</p>
<p>Also, it is not an interest of <b>Page Flow Module</b> to provide a <i>bridging</i> solution between <tt>HstComponent</tt> and other web flow control frameworks such as Spring Web Flow because that kind of approaches would simply force the flow interactions to stay in the specific <tt>HstComponent</tt> only, causing inflexibility in page/component compositions and significant limitations in Relevance personalization and Experiment (A/B Testing).</p></div>
<div class="section">
<h3><a name="Page_Flow_Definition"></a>Page Flow Definition</h3>
<p>First of all, you need to create and publish a <b>Page Flow Definition</b> which is applied to a Microsite campaign channel or selected sitemap items, like the following example document in CMS:</p>

<blockquote>
<p><img src="images/demoflowdef1.png" alt="Demo Page Flow Definition 1" /></p>
</blockquote>
<div class="section">
<h4><a name="Fields_of_Page_Flow_Definition"></a>Fields of Page Flow Definition</h4>

<table border="0" class="table table-striped">
  <thead>
    
<tr class="a">
      
<th align="center">Field name </th>
      
<th align="center">Description </th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td align="center">Name </td>
      
<td align="center">Human readable name of Page Flow Definition </td>
    </tr>
    
<tr class="a">
      
<td align="center">Flow ID </td>
      
<td align="center">Unique Identifier of Page Flow Definition, used by system </td>
    </tr>
    
<tr class="b">
      
<td align="center">Description </td>
      
<td align="center">Informative description of Page Flow Definition </td>
    </tr>
    
<tr class="a">
      
<td align="center">Page States </td>
      
<td align="center">Page State Compounds field </td>
    </tr>
    
<tr class="b">
      
<td align="center">Event Definitions </td>
      
<td align="center">Event Definitions field </td>
    </tr>
    
<tr class="a">
      
<td align="center">Global Page Transitions </td>
      
<td align="center">Globally applied Page Transitions on each Page State </td>
    </tr>
  </tbody>
</table></div>
<div class="section">
<h4><a name="Fields_of_Each_Page_State_Compound"></a>Fields of Each Page State Compound</h4>

<table border="0" class="table table-striped">
  <thead>
    
<tr class="a">
      
<th align="center">Field name </th>
      
<th align="center">Description </th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td align="center">Name </td>
      
<td align="center">Human readable name of Page State Definition </td>
    </tr>
    
<tr class="a">
      
<td align="center">Page State ID </td>
      
<td align="center">Unique Identifier in a Page Flow Definition, used by system </td>
    </tr>
    
<tr class="b">
      
<td align="center">Path </td>
      
<td align="center">Logical (URI) Path Info to be interpreted by application </td>
    </tr>
    
<tr class="a">
      
<td align="center">Metadata </td>
      
<td align="center">Extra custom metadata, which can be used by application </td>
    </tr>
    
<tr class="b">
      
<td align="center">Page Transitions </td>
      
<td align="center">Page Transition Compounds field </td>
    </tr>
  </tbody>
</table></div>
<div class="section">
<h4><a name="Fields_of_Each_Page_Transition_Compound"></a>Fields of Each Page Transition Compound</h4>

<table border="0" class="table table-striped">
  <thead>
    
<tr class="a">
      
<th align="center">Field name </th>
      
<th align="center">Description </th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td align="center">Event </td>
      
<td align="center">The source Event, to be selected from <b>Event Definitions</b> </td>
    </tr>
    
<tr class="a">
      
<td align="center">Target </td>
      
<td align="center">The target Page State to transition, to be selected from defined *<i>Page State</i>*s. </td>
    </tr>
  </tbody>
</table></div>
<div class="section">
<h4><a name="Fields_of_Each_Event_Definition_Compound"></a>Fields of Each Event Definition Compound</h4>

<table border="0" class="table table-striped">
  <thead>
    
<tr class="a">
      
<th align="center">Field name </th>
      
<th align="center">Description </th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td align="center">Name </td>
      
<td align="center">The unique identifier of an event in Page Flow Definition </td>
    </tr>
    
<tr class="a">
      
<td align="center">Value </td>
      
<td align="center">The human readable name of an event </td>
    </tr>
  </tbody>
</table>
<p>The above <b>Page Flow Definition</b> document defines all the page states, events and transitions in the document editor. It shows all the definitions including <i><i>Page State</i><i>s, </i><i>Event</i><i>s and </i><i>Page Transition</i><i>s in flat lists. But, due to the </i><i>Page Transition</i></i> fields, each of which consists of a source <b>Event</b> and a target <b>Page State</b>, the whole <b>Page Flow</b> can represents the following <i>Finite State Machine</i> diagram:</p>

<blockquote>
<p><img src="images/demoflowfsm1.png" alt="Demo Finite State Machine 1" /></p>
</blockquote></div></div>
<div class="section">
<h3><a name="Page_State_Definition_and_HST_Page"></a>Page State Definition and HST Page</h3>
<p>As shown above, each <b>Page State</b> has <b>Path</b> field which is normally mapped to the URI path of an <b>HST Page</b>. So, while a <b>Page Flow</b> instance for a visitor is alive, the visitor should be passing along a specific <b>Page State</b> based on events and transitions. By default in HST-2 web application, each <b>Page State</b> is represented by an <b>HST Page</b>, which means that the request from a visitor hits an <b>HST SiteMap Item</b> and the associated <b>HST Page</b> is being rendered for the <b>Page State</b>.</p>
<p>This default behavior in HST-2 web application has the following advantages:</p>

<ul>
  
<li>You can separate each step of the visitor&#x2019;s interactions into a separate <b>HST Page</b>, so it is more flexible  when composing each page with different components/templates and personalization.</li>
  
<li>You can even set a specific step page URI as an Experiment goal easily.</li>
  
<li>In an <b>HST Page</b>, one of <tt>HstComponent</tt>s may process an action to retrieve the current <tt>PageFlow</tt> to send an event  to trigger an automatic transition. Once a transition occurs by the event, the default <b>Page Flow HstSiteMapItemHandler</b>  will redirect the page to the next step automatically.  Therefore, <tt>HstComponent</tt>s do not have to handle any physical navigation/redirection handling by themselves any more  as it is handled by <b>Page Flow Module</b>.</li>
</ul>
<p><i>Note</i>: It is possible to customize the default HST-2 based Page Flow Control and interpret the logical <b>Path</b>  information of each <b>Page State</b> in application-specific ways.</p></div>
<div class="section">
<h3><a name="Events_and_Page_State_Transitions"></a>Events and Page State Transitions</h3>
<p>Let&#x2019;s take a look at the <tt>CampaignQuoteComponent.java</tt>, as an example, shown in the first step landing page in the demo project:</p>

<div class="source">
<div class="source"><pre>public class CampaignQuoteComponent extends AbstractCampaignComponent {

    private static final Pattern US_ZIP_PATTERN = Pattern.compile(&quot;^\\d{5}$&quot;);

    @Override
    public void doAction(HstRequest request, HstResponse response) throws HstComponentException {
        final String zip = StringUtils.trim(request.getParameter(&quot;zip&quot;));

        final PageFlow pageFlow = getPageFlow();
        final CampaignModel campaignModel = new CampaignModel();
        campaignModel.setZip(zip);
        pageFlow.setAttribute(CampaignConstants.DEFAULT_MODEL_NAME, campaignModel);

        if (StringUtils.isNotEmpty(zip)) {
            final Matcher m = US_ZIP_PATTERN.matcher(zip);

            if (m.matches()) {
                pageFlow.sendEvent(CampaignConstants.EVENT_START_QUOTE);
            }
        }
    }

}
</pre></div></div>
<p><i>CampaignQuoteComponent#doAction()</i> method is invoked when a visitor clicks on <b>Start!</b> button in the first landing page, doing the following:</p>

<ul>
  
<li>Read the only form input, &#x201c;zip&#x201d; code.</li>
  
<li>Retrieve the current <tt>PageFlow</tt> instance which was resolved and provided by the <b>Page Flow Module</b> automatically.</li>
  
<li>Instantiate a new domain model object, <tt>CampaignModel</tt>, set the zip code and store it into <tt>pageFlow</tt>, so that you can retrieve  the domain model object later in other *<i>Page State</i>*s.</li>
  
<li>Finally, if everything is okay, it sends an event named <tt>CampaignConstants.EVENT_START_QUOTE</tt> (which should be same as one of the event names in the <b>Page Flow Definition</b> document).</li>
  
<li>Under the hood, <b>Page Flow Module</b> process the event and make transition(s) if needed.  In this example, it will be transitioned to the next step (&#x201c;Select a Plan&#x201d;) automatically.</li>
</ul>
<p>In summary,</p>

<ul>
  
<li><tt>HstComponent</tt>s should not try to redirect pages in most cases, but instead it simply retrieves the currently resolved <tt>PageFlow</tt> and sends an event to trigger transitions.</li>
  
<li>To send an event from an <tt>HstComponent</tt>, invoke <tt>PageFlow#sendEvent(String eventName)</tt>.  Then <b>Page Flow Module</b> will automatically handle the event and make transition(s) if needed, as you defined  the flow in the <b>Page Flow Definition</b> document.</li>
</ul></div>
<div class="section">
<h3><a name="APIs_to_Get_Access_to_PageFlow_and_PageStates"></a>APIs to Get Access to PageFlow and PageStates</h3>
<p>You can retrieve the automatically resolved <tt>PageFlow</tt> instance like the following:</p>

<div class="source">
<div class="source"><pre>    protected PageFlow getPageFlow() {
        final HstRequestContext requestContext = RequestContextProvider.get();
        final PageFlowControl flowControl = PageFlowControl.getDefault(requestContext.getServletRequest());
        return flowControl.getPageFlow(requestContext.getServletRequest());
    }
</pre></div></div>
<p><i>HstComponent</i> code should retrieve the <tt>PageFlowControl</tt> by invoking <tt>PageFlowControl#getDefault(HttpServletRequest)</tt> first, and get the <tt>PageFlow</tt> throught <tt>PageFlowControl#getPageFlow(HttpServletRequest)</tt>.</p>
<p><b>Page Flow Module</b> automatically finds a <b>PageFlow</b> instance for the visitor by retrieving a stored one or instantiate a new one if it is a new visitor.</p>
<p>You can also retrieve all the defined <b>PageState</b> s from the <b>PageFlow</b>.</p>
<p>The following FreeMarker template example is from the navigation status bar at the page bottom in the demo project:</p>

<div class="source">
<div class="source"><pre>&lt;#assign curPageState=pageFlow.pageState&gt;
&lt;#assign curPageStateIndex=curPageState.index&gt;

&lt;div class=&quot;text-left&quot;&gt;
  &lt;#list pageFlow.pageStates as pageState&gt;
    &lt;#if pageState.index &lt; curPageStateIndex&gt;
      &lt;span class=&quot;label label-success&quot;&gt;${pageState.name}&lt;/span&gt;
    &lt;#elseif pageState.index == curPageStateIndex&gt;
      &lt;span class=&quot;label label-primary&quot;&gt;${pageState.name}&lt;/span&gt;
    &lt;#else&gt;
      &lt;span class=&quot;label label-default&quot;&gt;${pageState.name}&lt;/span&gt;
    &lt;/#if&gt;
  &lt;/#list&gt;
&lt;/div&gt;
</pre></div></div>
<p><i>PageFlow#getPageState()</i> returns the current <b>PageState</b>. <tt>PageFlow#getPageStates()</tt> returns a collection of all the defined <b>PageState</b> s.</p>
<p>For more details, see <a href="apidocs/index.html">JavaDocs</a>.</p></div>
<div class="section">
<h3><a name="APIs_to_Store_Domain_Objects_in_Page_Flow"></a>APIs to Store Domain Objects in Page Flow</h3>
<p>A Page Flow for a visitor is a longer journey than simple webpage. So, you might want to store some domain specific data for the visitor&#x2019;s journey. e.g, multi-step application form data.</p>
<p>As shown above, you may use <tt>PageFlow#setAttribute(String, Object)</tt> to store and retrieve arbitrary objects for your application.</p>
<p>For more details, see <a href="apidocs/index.html">JavaDocs</a>.</p></div>
<div class="section">
<h3><a name="APIs_for_Error_Handling_in_Page_State"></a>APIs for Error Handling in Page State</h3>
<p>In an <tt>HstComponent</tt>, you might want to store all the collected errors while processing the form and use those error objects in view templates.</p>
<p>To store error objects, you can use <tt>PageState#addErrors(Errors)</tt>, <tt>PageState#getErrorsMap()</tt>, etc.</p>
<p>For more details, see <a href="apidocs/index.html">JavaDocs</a>.</p>
<p>A good example for error handling <tt>HstComponent</tt> and FreeMarker template can be found in the following sources in the demo project:</p>

<ul>
  
<li><a class="externalLink" href="https://github.com/onehippo-forge/page-flow/blob/master/demo/site/src/main/java/org/onehippo/forge/pageflow/demo/campaign/components/CampaignApplicationFormComponent.java">CampaignApplicationFormComponent.java</a></li>
  
<li><a class="externalLink" href="https://github.com/onehippo-forge/page-flow/blob/master/demo/repository-data/webfiles/src/main/resources/site/freemarker/campaignbase/campaign-application-form.ftl">campaign-application-form.ftl</a></li>
</ul></div></div>
    </div>
    </div>
    </div>
    <hr/>
    <footer>
    <div class="container-fluid">
      <div class="row-fluid">
          <p class="copyright">Copyright &copy;      2018.
  Hippo B.V. All rights reserved.
</p>
    </div>
            </div>
  </footer>
    </body>
</html>

